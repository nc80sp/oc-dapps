<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Snake Game</title>
    <style>
        body {
            margin: 0;
            background: #222;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: white;
            font-family: sans-serif;
        }

        canvas {
            background: #111;
            border: 2px solid #444;
            display: none;
        }

        #score {
            position: fixed;
            top: 10px;
            font-size: 24px;
            display: none;
        }

        #startScreen {
            text-align: center;
            line-height: 1.6;
        }

        #startButton,
        #replayButton {
            padding: 20px 50px;
            font-size: 26px;
            border: none;
            background: #4caf50;
            color: white;
            border-radius: 10px;
            margin-top: 20px;
        }

        .desc {
            margin-top: 20px;
            font-size: 18px;
            opacity: 0.9;
        }
    </style>
</head>

<body>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="../ocpass.js"></script>
    <p id="msg" style="margin: 10px; color: rgb(255, 255, 255);"> 読み込み中...</p>
    <div id="content" style="display: none;">
        <div id="startScreen">
            <h1>Snake Game</h1>
            <strong id="reward">スコア10以上で <span style="color: rgb(255, 0, 0);">0.05 SepoliaETH</span> をゲット！</strong><br>
            <div class="desc">
                <strong>【操作方法】</strong><br>
                PC：矢印キー または WASD で移動<br>
                スマホ：画面をスワイプして移動
            </div>

            <button id="startButton">ゲーム開始</button>
        </div>

        <div id="endScreen" style="text-align: center; display: none;">
            <h1>ゲームオーバー</h1>
            <h1 id="resultScore">スコア:10</h1><br>
            <h2 id="resultText" style="display: none;">
                スコア10を超えたため、<br>
                <span style="color: rgb(255, 0, 0);">0.05 SepoliaETH</span> を獲得！
            </h2>
            <button id="replayButton">もう一度プレイ</button>
        </div>

        <canvas id="game" width="400" height="400"></canvas>
        <div id="score">スコア: 0</div>
    </div>
    <script>
        const canvas = document.getElementById("game");
        const ctx = canvas.getContext("2d");
        const scoreText = document.getElementById("score");
        const startScreen = document.getElementById("startScreen");
        const endScreen = document.getElementById("endScreen");
        const resultScore = document.getElementById("resultScore");
        const resultText = document.getElementById("resultText");
        const replayButton = document.getElementById("replayButton");

        const grid = 20;
        let snake, dx, dy, food, score, speed;
        let running = false;
        let claimed = false;

        async function connect() {
            let result = await connectWallet(true);
            if (!result) {
                document.getElementById("status").textContent = `接続に失敗しました`;
                return;
            }
            //接続後にコンテンツ表示
            document.getElementById("msg").innerHTML = "";
            document.getElementById("content").style.display = "block";
        }
        document.addEventListener("DOMContentLoaded", async () => {
            connect();
        });

        function initGame() {
            snake = [{ x: 200, y: 200 }];
            dx = grid;
            dy = 0;
            food = randomFood();
            score = 0;
            speed = 100;
            scoreText.textContent = "スコア: 0";
        }

        function randomFood() {
            return {
                x: Math.floor(Math.random() * 20) * grid,
                y: Math.floor(Math.random() * 20) * grid
            };
        }

        function startGame() {
            startScreen.style.display = "none";
            endScreen.style.display = "none";
            canvas.style.display = "block";
            scoreText.style.display = "block";
            resultText.style.display = "none";
            initGame();
            running = true;
            gameLoop();
        }

        function gameLoop() {
            if (!running) return;

            setTimeout(() => {
                requestAnimationFrame(gameLoop);

                const head = { x: snake[0].x + dx, y: snake[0].y + dy };

                // 壁衝突
                if (
                    head.x < 0 || head.x >= canvas.width ||
                    head.y < 0 || head.y >= canvas.height
                ) {
                    gameOver();
                    return;
                }

                // 体に衝突
                for (let i = 0; i < snake.length; i++) {
                    if (head.x === snake[i].x && head.y === snake[i].y) {
                        gameOver();
                        return;
                    }
                }

                snake.unshift(head);

                // 餌
                if (head.x === food.x && head.y === food.y) {
                    score++;
                    scoreText.textContent = "スコア: " + score;
                    food = randomFood();
                    speed = Math.max(40, speed - 2);
                } else {
                    snake.pop();
                }

                draw();
            }, speed);
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // スネーク
            if (score >= 10) {
                ctx.fillStyle = "#ffff11";
            } else {
                ctx.fillStyle = "#4da6ff";
            }
            snake.forEach(part => ctx.fillRect(part.x, part.y, grid, grid));

            // 餌
            ctx.fillStyle = "#ff4444";
            ctx.fillRect(food.x, food.y, grid, grid);
        }

        async function gameOver() {
            running = false;

            replayButton.style.display = "none";
            canvas.style.display = "none";
            scoreText.style.display = "none";
            endScreen.style.display = "block";
            resultScore.innerHTML = "スコア:" + score;
            if (score >= 10) {
                if (claimed == true && await checkClaimed() == true) {
                    resultText.style.display = "block";
                    resultText.innerHTML = "報酬は獲得済みです";
                    claimed = true;
                } else {
                    resultText.style.display = "block";
                    let result = await claimedReward();
                    if (result == false) {
                        resultText.innerHTML = "報酬獲得に失敗しました";
                    } else {
                        claimed = true;
                    }
                }
            }
            replayButton.style.display = "block";
        }

        // PC操作
        document.addEventListener("keydown", e => {
            if (e.key === "ArrowUp" || e.key === "w") {
                if (dy === 0) { dx = 0; dy = -grid; }
            }
            if (e.key === "ArrowDown" || e.key === "s") {
                if (dy === 0) { dx = 0; dy = grid; }
            }
            if (e.key === "ArrowLeft" || e.key === "a") {
                if (dx === 0) { dx = -grid; dy = 0; }
            }
            if (e.key === "ArrowRight" || e.key === "d") {
                if (dx === 0) { dx = grid; dy = 0; }
            }
        });

        // スマホ操作（スワイプ）
        let touchStartX, touchStartY;

        canvas.addEventListener("touchstart", e => {
            const t = e.touches[0];
            touchStartX = t.clientX;
            touchStartY = t.clientY;
        });

        canvas.addEventListener("touchmove", e => {
            e.preventDefault();
            const t = e.touches[0];
            const dxTouch = t.clientX - touchStartX;
            const dyTouch = t.clientY - touchStartY;

            if (Math.abs(dxTouch) > Math.abs(dyTouch)) {
                if (dxTouch > 0 && dx !== -grid) { dx = grid; dy = 0; }
                else if (dxTouch < 0 && dx !== grid) { dx = -grid; dy = 0; }
            } else {
                if (dyTouch > 0 && dy !== -grid) { dx = 0; dy = grid; }
                else if (dyTouch < 0 && dy !== grid) { dx = 0; dy = -grid; }
            }

            touchStartX = t.clientX;
            touchStartY = t.clientY;
        });

        document.getElementById("startButton").addEventListener("click", startGame);
        document.getElementById("replayButton").addEventListener("click", startGame);

    </script>

</body>

</html>