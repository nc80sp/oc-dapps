<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <title>Paid Access Payment</title>
</head>

<body style="font-family:sans-serif; text-align:center; margin-top:50px;">
    <h1>ğŸ« æœ‰æ–™ã‚¢ã‚¯ã‚»ã‚¹ãƒšãƒ¼ã‚¸</h1>
    <p id="status">ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚’æ¥ç¶šã—ã¦ãã ã•ã„ã€‚</p>
    <button id="payButton" style="display:none;"></button>

    <!-- âœ… ethers.js v5 ã‚’æ­£ã—ãèª­ã¿è¾¼ã‚€ -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="../ocpass.js"></script>

    <!-- âœ… ã‚ãªãŸã®ã‚³ãƒ¼ãƒ‰ã¯ã“ã“ã‹ã‚‰ -->
    <script>
        let pageId, fee;

        async function connect() {
            await connectWallet();

            const params = new URLSearchParams(window.location.search);
            pageId = params.get("id");

            document.getElementById("status").textContent = `ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæ¥ç¶šä¸­...`;
            checkPay();
        }

        async function checkPay() {
            fee = await contract.getPageFee(pageId);
            fee = ethers.utils.formatEther(fee);
            const hasAccess = await contract.checkAccess(userAddress, pageId);
            const payButton = document.getElementById("payButton");
            payButton.innerHTML = fee + " SepoliaETH ã‚’æ”¯æ‰•ã†";

            if (hasAccess) {
                document.getElementById("status").textContent = "âœ… æ”¯æ‰•ã„æ¸ˆã¿ã§ã™ï¼ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™...";
                redirectToFolder();
            } else {
                document.getElementById("status").textContent = "âŒ ãƒšãƒ¼ã‚¸é–²è¦§ã«ã¯æ”¯æ‰•ã„ãŒå¿…è¦ã§ã™ã€‚";
                payButton.style.display = "inline-block";
            }
        }

        async function payForAccess() {
            const price = ethers.utils.parseEther(fee);
            const tx = await contract.payForPage(pageId, { value: price });
            document.getElementById("status").textContent = "â³ æ”¯æ‰•ã„å‡¦ç†ä¸­...";
            payButton.style.display = "none";
            await tx.wait();
            document.getElementById("status").textContent = "âœ… æ”¯æ‰•ã„ãŒå®Œäº†ã—ã¾ã—ãŸï¼ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™...";
            redirectToFolder();
        }

        function redirectToFolder() {
            if (!pageId) return alert("idãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
            const base = window.location.origin;
            const target = `${base}/contents/${pageId}/index.html`;
            setTimeout(() => (window.location.href = target), 1500);
        }

        document.addEventListener("DOMContentLoaded", async () => {
            connect();
        });

        document.getElementById("payButton").addEventListener("click", payForAccess);
    </script>
</body>

</html>