<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <title>Paid Access Payment</title>
</head>

<body style="font-family:sans-serif; text-align:center; margin-top:50px;">
    <h1>ğŸ« æœ‰æ–™ã‚¢ã‚¯ã‚»ã‚¹ãƒšãƒ¼ã‚¸</h1>
    <p id="status">ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚’æ¥ç¶šã—ã¦ãã ã•ã„ã€‚</p>
    <button id="connectButton">MetaMaskæ¥ç¶š</button>
    <button id="payButton" style="display:none;"></button>

    <!-- âœ… ethers.js v5 ã‚’æ­£ã—ãèª­ã¿è¾¼ã‚€ -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

    <!-- âœ… ã‚ãªãŸã®ã‚³ãƒ¼ãƒ‰ã¯ã“ã“ã‹ã‚‰ -->
    <script>
        const CONTRACT_ADDRESS = "0xd5Ba89f8a5a07Bf1409DCaAF2E1827840B96e173"; // ã‚ãªãŸã®ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã«ç½®ãæ›ãˆ
        const ABI = [
            "function payForPage(uint256) payable",
            "function checkAccess(address,uint256) view returns (bool)",
            "function withdraw() onlyOwner"
        ];

        //å„ãƒšãƒ¼ã‚¸ã®æ–™é‡‘
        const PagePrice = [
            0.005,
            0.003,
            0.002,
            0.001,
            0.01
        ];

        let provider, signer, contract, userAddress, pageId;

        async function connectWallet() {
            if (!window.ethereum) {
                alert("MetaMaskãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            const connectButton = document.getElementById("connectButton");
            connectButton.style.display = "none";

            const params = new URLSearchParams(window.location.search);
            pageId = params.get("id");

            // âœ… ethers.providers.Web3Provider ã¯ v5 ç”¨
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            userAddress = await signer.getAddress();

            contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
            document.getElementById("status").textContent = `æ¥ç¶šä¸­: ${userAddress}`;
            checkAccess();
        }

        async function checkAccess() {
            const hasAccess = await contract.checkAccess(userAddress, pageId);
            const payButton = document.getElementById("payButton");
            payButton.innerHTML = PagePrice[pageId - 1] + " SepoliaETH ã‚’æ”¯æ‰•ã†";

            if (hasAccess) {
                document.getElementById("status").textContent = "âœ… æ”¯æ‰•ã„æ¸ˆã¿ã§ã™ï¼ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™...";
                redirectToFolder();
            } else {
                document.getElementById("status").textContent = "âŒ æ”¯æ‰•ã„ãŒå¿…è¦ã§ã™ã€‚";
                payButton.style.display = "inline-block";
            }
        }

        async function payForAccess() {
            const price = ethers.utils.parseEther(PagePrice[pageId - 1]);
            const tx = await contract.payForPage(pageId, { value: price });
            document.getElementById("status").textContent = "â³ æ”¯æ‰•ã„å‡¦ç†ä¸­...";
            await tx.wait();
            document.getElementById("status").textContent = "âœ… æ”¯æ‰•ã„ãŒå®Œäº†ã—ã¾ã—ãŸï¼ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™...";
            document.getElementById("payButton").style.display = "none";
            redirectToFolder();
        }

        function redirectToFolder() {
            if (!pageId) return alert("idãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
            const base = window.location.origin;
            const target = `${base}/contents/${pageId}/index.html`;
            setTimeout(() => (window.location.href = target), 1500);
        }

        document.getElementById("connectButton").addEventListener("click", connectWallet);
        document.getElementById("payButton").addEventListener("click", payForAccess);
    </script>
</body>

</html>